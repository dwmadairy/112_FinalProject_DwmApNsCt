---
title: "MadairyData"
author: "Will Madairy"
date: "11/14/2019"
output: html_document
---
```{r}
library(foreign)
library(tidyverse)
library(ggplot2)
library(readr)
```


```{r}
climber <- read.csv("climber.csv")
```


```{r warning=FALSE message = FALSE}
peaks <- read_csv("peaks.csv")
```

```{r}
climberpeakold <- climber %>% 
  left_join(peaks, by = "PEAKID")
```
```{r}
climberpeak <- write_csv(climberpeakold, "climberpeak.csv")
```

```{r}
climberpeak %>% 
  group_by(PKNAME, YEAR)
```
```{r}
climberpeak2 <- climberpeak %>% 
  mutate(pctcomplete = HIGHPOINT/HEIGHTM)
```


```{r}
manyexpeds<-climberpeak %>% 
  group_by(PKNAME) %>% 
  mutate(expeds = sum(n())) %>% 
  filter(expeds > 5) %>% 
  ungroup()
```

```{r}
manyexpeds %>% 
  group_by(PKNAME) %>% 
  summarize(expeds=sum(n())) %>% 
  arrange(desc(expeds))
```

```{r eval=FALSE}
climberpeak2 %>% 
  group_by(YEAR) %>% 
  summarize(avgcomplete = mean(pctcomplete)) %>% 
  ggplot(aes(x=YEAR, y=avgcomplete))+
  geom_line()
```

```{r}
write.csv(climberpeak2, file="climberpeakV2.csv")
```



TERM Reasons:

0. 
1. Success
2. 
3. Disputed or Illegeal summit
4. Poor Weather, and related issues
5. Avalanche/Snow Fall
6. Fatality
7. illness/injury
8. Supplies Problem
9. Lack of time or too late in day
10. Difficulty in route
12. Did not attempt climb
14. Unknown or misc. 
  Largest issues are issues with Chines Gov, Sherpa strike, and Nepal earthquake

```{r}
climberpeak2 %>% 
  filter(PKNAME=="Everest") %>% 
  ggplot()+
  geom_bar(aes(x=TERMREASON))
```

```{r}
rsns = c(3 ,4, 5, 6 , 9 ,14)

climberpeak2 %>% 
  filter(PKNAME=="Everest" ) %>% 
  filter (TERMREASON %in% rsns) %>% 
  ggplot(aes(x=YEAR, y=HIGHPOINT,  color=factor(TERMREASON))) +
  geom_point()+
  geom_line(y=8848, color="red") 
```

Table explanation


```{r}
manyexpeds %>% 
  group_by(PKNAME) %>% 
  summarize(expeds=sum(n()), success_rate = sum(SUCCESS1)/expeds) %>% 
  arrange(desc(success_rate))

```

```{r}
climberpeak2 %>% 
  filter(PKNAME=="Jannu East") %>% 
  filter(TERMREASON==14)
```

```{r}
climberpeak2 %>% 
  filter(PKNAME=="Nuptse") %>% 
  ggplot()+
  geom_bar(aes(x=TERMREASON))
```

```{r}
climberpeak2 %>% 
  filter(PKNAME=="Nuptse") %>% 
  filter(TERMREASON==6)
```

```{r}
climberpeak2 %>% 
  select(TERMREASON,TERMNOTE) %>% 
  filter(TERMREASON==9) 
```


```{r}
rsns = c(3 ,4, 5, 6 ,7, 9 ,14)

climberpeak2 %>% 
  group_by(YEAR, TERMREASON) %>% 
  filter(TERMREASON %in% rsns) %>% 
  summarize(expeds = sum(n())) %>% 
  ggplot(aes(x=YEAR, y=expeds, group=factor(TERMREASON)))+
  geom_area(aes(fill=factor(TERMREASON)))+
  geom_line(aes(group=TERMREASON),position="stack")+
  xlim(c(1975, 2018))
```


TERM Reasons:

0. 
1. Success
2. 
3. Disputed or Illegeal summit
4. Poor Weather, and related issues
5. Avalanche/Snow Fall
6. Fatality
7. illness/injury
8. Supplies Problem
9. Lack of time or too late in day
10. Difficulty in route
12. Did not attempt climb
14. Unknown or misc. 

```{r}
rsns = c(4, 5, 6 ,7, 8, 9)
rsns_legend=c("Weather",  "Avalanche or Snow Fall", "Fatality", "Illness or Injury", "Lack of Supplies", "Lack of Time")

climberpeak2 %>% 
  group_by(YEAR, TERMREASON) %>% 
  filter(TERMREASON %in% rsns) %>% 
  summarize(expeds = sum(n())) %>% 
  ggplot(aes(x=YEAR, y=expeds, fill=factor(TERMREASON)))+
  geom_area(aes(fill=factor(TERMREASON)))+
  geom_line(aes(group=TERMREASON),position="stack")+
  xlim(c(1975, 2018))+
  scale_fill_discrete(name="Termination Reason", breaks=rsns, labels=rsns_legend)
  
```

In this grpah we see that there has been an increase in failed expeditions in recent years.


```{r}
rsns = c(4, 5, 6 ,7, 8, 9)
rsns_legend=c("Weather",  "Avalanche or Snow Fall", "Fatality", "Illness or Injury", "Lack of Supplies", "Lack of Time")

climberpeak %>% 
  filter(PKNAME=="Everest") %>% 
  filter(TERMREASON %in% rsns) %>% 
  group_by(YEAR, TERMREASON) %>% 
  summarize(expeds_term_year = sum(n())) %>% 
  group_by(YEAR) %>% 
  mutate(yearprop=expeds_term_year/sum(expeds_term_year)) %>% 
  ggplot(aes(x=YEAR, yearprop, color=factor(TERMREASON)))+
  geom_line(position="stack")+
  geom_area(aes(fill=factor(TERMREASON)))+
  xlim(c(1975, 2018))+
  scale_fill_discrete(name="Termination Reason", breaks=rsns, labels=rsns_legend)

```
In this plot we are looking at the reasons in which most expeditions fail in the himalayas. In  this plot we can generally see that there have been fewer expeditions that have ended due to fatalities in the mountains but more have failed due to injury and illness. 

```{r}
climberpeak2 %>% 
  mutate(death=str_detect(TERMNOTE, "death"|"killed"|"fatal"|"disappeared"|"disappearence")) %>% 
  replace_na(death=FALSE) %>% 
  mutate(injury=str_detect(TERMNOTE, "injured"|""))
  mutate(sickness=str_detect(TERMNOTE, "illness"|"sick"|"ill"|"sickness"|"infection"))
```

manyexpeds<-climberpeak %>% 
  group_by(PKNAME) %>% 
  mutate(expeds = sum(n())) %>% 
  filter(expeds > 5) %>% 
  ungroup()

```{r}
toppeaks<-climberpeak %>% 
  group_by(PKNAME) %>% 
  summarize(expeds = sum(n())) %>% 
  arrange(desc(expeds)) %>% 
  select(PKNAME) %>% 
  head(n=15)
 
```


```{r}

inputPanel(
  selectInput("Mountain", "Mountain of Interest", toppeaks)
)
rsns = c(4, 5, 6 ,7, 8, 9)
rsns_legend=c("Weather",  "Avalanche or Snow Fall", "Fatality", "Illness or Injury", "Lack of Supplies", "Lack of Time")

renderPlot({
  climberpeak %>% 
    filter(PKNAME == input$Mountains) %>% 
    filter(TERMREASON %in% rsns) %>% 
    group_by(YEAR, TERMREASON) %>% 
    summarize(expeds_term_year = sum(n())) %>% 
    group_by(YEAR) %>% 
    mutate(yearprop=expeds_term_year/sum(expeds_term_year)) %>% 
    ggplot(aes(x=YEAR, yearprop, color=factor(TERMREASON)))+
    geom_line(position="stack")+
    geom_area(aes(fill=factor(TERMREASON)))+
    xlim(c(1975, 2018))+
    scale_fill_discrete(name="Termination Reason", breaks=rsns, labels=rsns_legend)
  })
```

